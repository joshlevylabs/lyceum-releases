name: Register New Version

on:
  release:
    types: [published]

jobs:
  register-version:
    runs-on: ubuntu-latest

    steps:
      - name: Extract version from tag
        id: version
        run: |
          # Extract version from tag (e.g., v1.0.2 -> 1.0.2)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version detected: $VERSION"

      - name: Determine brand type
        id: brand
        run: |
          # Determine brand based on repository name
          REPO_NAME="${{ github.event.repository.name }}"
          if [[ "$REPO_NAME" == *"centcom"* ]]; then
            BRAND="centcom"
          else
            BRAND="lyceum"
          fi
          echo "brand=$BRAND" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸  Brand detected: $BRAND"

      - name: Register version with Lyceum API
        id: register
        env:
          LYCEUM_API_URL: ${{ secrets.LYCEUM_API_URL }}
          LYCEUM_API_KEY: ${{ secrets.LYCEUM_API_KEY }}
          VERSION: ${{ steps.version.outputs.version }}
          BRAND: ${{ steps.brand.outputs.brand }}
        run: |
          echo "ðŸš€ Registering version $VERSION for $BRAND..."

          # Remove trailing slash from URL if present
          API_URL="${LYCEUM_API_URL%/}"

          # Make sure URL starts with https://
          if [[ ! "$API_URL" =~ ^https?:// ]]; then
            API_URL="https://${API_URL}"
          fi

          echo "ðŸ”— API URL: $API_URL"

          RESPONSE=$(curl -L -X POST "$API_URL/api/admin/versions/register" \
            -H "Authorization: Bearer $LYCEUM_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "version": "'"$VERSION"'",
              "brand_type": "'"$BRAND"'",
              "platform": "windows",
              "github_release_url": "'"${{ github.event.release.html_url }}"'",
              "release_tag": "'"${{ github.event.release.tag_name }}"'"
            }' \
            -w "\n%{http_code}" \
            -s)

          # Extract HTTP status code (last line)
          HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
          # Extract response body (all but last line)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "ðŸ“¡ HTTP Status: $HTTP_STATUS"
          echo "ðŸ“„ Response: $BODY"

          if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 201 ]; then
            echo "âœ… Version registered successfully"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed to register version"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Post success summary
        if: steps.register.outputs.status == 'success'
        run: |
          echo "## âœ… Version Registration Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version **${{ steps.version.outputs.version }}** has been registered in Lyceum Admin Panel." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Unreleased (requires admin approval)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [Manage Versions in Admin Panel](${{ secrets.LYCEUM_API_URL }}/admin/versions)" >> $GITHUB_STEP_SUMMARY

      - name: Post failure summary
        if: failure()
        run: |
          echo "## âŒ Version Registration Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Failed to register version **${{ steps.version.outputs.version }}** in Lyceum." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the workflow logs above for details." >> $GITHUB_STEP_SUMMARY
