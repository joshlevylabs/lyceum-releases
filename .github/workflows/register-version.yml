name: Register New Version

on:
  release:
    types: [published]

jobs:
  register-version:
    runs-on: ubuntu-latest

    steps:
      - name: Extract version from tag
        id: version
        run: |
          # Extract version from tag (e.g., v1.0.2 -> 1.0.2)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Version detected: $VERSION"

      - name: Determine brand type
        id: brand
        run: |
          # Determine brand based on repository name
          REPO_NAME="${{ github.event.repository.name }}"
          if [[ "$REPO_NAME" == *"centcom"* ]]; then
            BRAND="centcom"
          else
            BRAND="lyceum"
          fi
          echo "brand=$BRAND" >> $GITHUB_OUTPUT
          echo "üè∑Ô∏è  Brand detected: $BRAND"

      - name: Register version with Lyceum API
        id: register
        env:
          LYCEUM_API_URL: ${{ secrets.LYCEUM_API_URL }}
          LYCEUM_API_KEY: ${{ secrets.LYCEUM_API_KEY }}
          VERSION: ${{ steps.version.outputs.version }}
          BRAND: ${{ steps.brand.outputs.brand }}
        run: |
          echo "üöÄ Registering version $VERSION for $BRAND..."

          RESPONSE=$(curl -X POST "$LYCEUM_API_URL/api/admin/versions/register" \
            -H "Authorization: Bearer $LYCEUM_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "version": "'"$VERSION"'",
              "brand_type": "'"$BRAND"'",
              "platform": "windows",
              "github_release_url": "'"${{ github.event.release.html_url }}"'",
              "release_tag": "'"${{ github.event.release.tag_name }}"'"
            }' \
            -w "\n%{http_code}" \
            -s)

          # Extract HTTP status code (last line)
          HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
          # Extract response body (all but last line)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "üì° HTTP Status: $HTTP_STATUS"
          echo "üìÑ Response: $BODY"

          if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 201 ]; then
            echo "‚úÖ Version registered successfully"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Failed to register version"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Post success comment
        if: steps.register.outputs.status == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.payload.release.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ Version **${{ steps.version.outputs.version }}** has been registered in Lyceum Admin Panel.\n\n**Status:** Unreleased (requires admin approval)\n\nüîó [Manage Versions in Admin Panel](${{ secrets.LYCEUM_API_URL }}/admin/versions)'
            })

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.payload.release.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå Failed to register version **${{ steps.version.outputs.version }}** in Lyceum.\n\nPlease check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })
